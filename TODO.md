# TODO / Дорожная карта

Набор типичных фич для менеджера домашней библиотеки и практичные способы их реализации в текущем Electron‑приложении.

## Приоритеты
- [P0] Критично/основа (сделать в первую очередь)
- [P1] Важно для версии 1.0
- [P2] Полезно для 1.x
- [P3] Дополнительно/расширения

## Каталог и метаданные
- [x] [P1] Расширенная схема книги: `title`, `authors[]`, `series`, `seriesIndex`, `year`, `publisher`, `isbn`, `format`, `language`, `genres[]`, `tags[]`, `rating`, `notes`, `location`.
- [x] [P1] Альтернативные поля для оригинала: `titleAlt`, `authorsAlt` (сохранение исходных значений при конвертации кириллицы).
- [ ] [P2] Серии и издания: поля `series` и `seriesIndex`; UI‑группировка по серии, сортировка по номеру.
- [ ] [P2] Форматы носителей: `format` (`paper`, `ebook`, `audiobook`), фильтры и иконки в UI.

## Файлы, обложки и вложения
- [ ] [P2] Вложения eBook/PDF: хранение копий в `userData/library/files`, в книге — `files[]` с `type`, `ext`, `size`.
- [ ] [P3] Генерация миниатюр: для ePub — cover из zip, для PDF — 1‑я страница через `pdfjs-dist`; кэш в `covers/`.
- [ ] [P2] Drag & Drop обложек: зона в форме, копирование и мгновенный предпросмотр.

## Чтение и выдача
- [ ] [P3] Прогресс чтения: `progress` 0–100, `lastReadAt`; индикатор в карточке.
- [ ] [P2] Учёт выдач: сущность `loans` (`borrower`, `dateOut`, `dueAt`, `dateIn`, `notes`); флаг «на руках», журнал.
- [ ] [P2] Рейтинг и заметки: звездочки/оценка и текстовые заметки (частично: поле rating/notes есть, нужен виджет звёзд и отображение в списке).

## Поиск и организация
- [x] [P0] Быстрый поиск: fuzzy‑поиск (Fuse.js) по названию/авторам/ISBN в рендерере (сделано для названия/авторов; осталось добавить по ISBN/тегам по желанию).
- [x] [P0] Надёжность: фолбэк на простой фильтр при отсутствии `window.search` в рендерере.
- [ ] [P1] Расширенные фильтры: авторы, жанры, формат, год, теги; сохранённые «умные коллекции».
- [ ] [P2] Дедупликация: поиск по нормализованным `title+authors` и/или `isbn`; мастер объединения записей.

## Импорт/экспорт/интеграции
- [ ] [P1] Импорт CSV/TSV: сопоставление колонок → предпросмотр → запись.
- [x] [P1] По ISBN: автозаполнение (ISBNdb как основной, Open Library fallback; кэш в БД с коротким TTL для «пустых», кнопка «Обновить» без кеша). Google Books — опционально.
- [x] [P1] AI‑обогащение ISBN (OpenAI): загрузка CSV → LLM → верификация через ISBNdb/OL → подтверждение; очередь, пауза/возобновление, игнорирование кэша, экспорт CSV, очистка кэша, отладочная панель (prompt/raw).
- [ ] [P3] OPDS/каталоги: импорт из OPDS‑фидов для eBook библиотек.
- [ ] [P2] Расширенный бэкап: инкрементные бэкапы, расписание, опциональное шифрование (AES‑GCM), проверка целостности.
- [ ] [P1] AI‑обогащение ISBN (OpenAI): загрузка CSV (без ISBN) → LLM подсказывает ISBN по названию/авторам/издателю/году → верификация через ISBNdb/OL → сравнение и подтверждение.

## UX и темизация
- [x] [P1] Детальная карточка/панель: модалка/слайд‑овер с метаданными, файлами, журналом (реализована модалка с расширенной формой).
- [x] [P1] Инструменты русификации: обратная транслитерация для названия/авторов из результатов провайдера + кнопка «Кириллицей» для поля «Издательство».
- [x] [P1] Настройки: модалка для ключей провайдеров (ISBNdb/Google Books), хранение в `userData/settings.json`.
- [x] [P1] Режимы просмотра: сетка/список (переключатели, `localStorage`, устойчивость обработчиков).
- [ ] [P1] Плотность списка (compact/normal) — переключатель и стили.
- [ ] [P1] Сортировки: название, автор, дата добавления, серия.
- [x] [P1] Клавиатурные шорткаты: Esc закрывает детали и настройки (с предупреждением при несохранённых изменениях); N — новая книга; / — поиск; Enter — сохранить в контексте; Delete — удалить выбранное.
- [ ] [P2] Локализация (i18n): ресурсы JSON, переключатель языка, хранение выбора.
- [ ] [P2] Светлая/тёмная/системная тема: добавить «Системная» (следовать `prefers-color-scheme`).
- [x] [P1] Вкладка «Обогащение»: мастер загрузки CSV, сопоставление колонок, запуск/пауза, прогресс, список результатов (статусы), «Принять», «Сохранить CSV», очистка кэша.
- [x] [P1] Переключатель «Обогащение ↔ Библиотека» в шапке: активное состояние, смена иконки на «домой» при включённом обогащении.
- [x] [P2] Сегментированные кнопки (.seg): убран внутренний разделитель между соседними кнопками.
- [x] [P2] Икон‑кнопки: добавлено активное состояние `.icon-btn.active` (подсветка в светлой/тёмной теме).
- [x] [P2] Модалки (детали/настройки): поверх хедера, вписываются по высоте вьюпорта с верх/низ отступами.
- [x] [P3] Хедер: удалён вспомогательный текст («Домашняя библиотека / учёт книг…») для компактности; добавлена кнопка «Перезагрузить без кэша».
- [x] [P1] Расширенная карточка: разгрузка строки ISBN; «Язык/Рейтинг/Теги» в одну строку; «Заметки» — textarea на 3 строки; порядок табов сохранён.
- [x] [P1] Настройки: поле «OpenAI API Base URL» (опционально).

## Данные и надёжность
- [x] [P0] Переход на SQLite: хранение на SQLite (реализовано через sql.js, wasm) с таблицами `books`, `authors`, `book_authors` и индексами.
- [x] [P0] Транзакции/очередь записи: атомарная запись БД через tmp+rename; сериализация записей через очередь (coalesce).
- [x] [P0] Миграции: версия схемы `schema_version` и миграции v1→v4 (v3 — `isbn_cache`, v4 — `titleAlt`/`authorsAlt`).
- [x] [P0] Идентификаторы: UUID v4 для связей и внешних файлов.
- [x] [P1] Переменные окружения: поддержка `.env` (dotenv) и загрузка ключей в main.
- [ ] [P1] Кэш LLM‑поиска: таблица `ai_isbn_cache` (ключ — хеш от title+authors+publisher+year), payload (ответ LLM), TTL (напр., 30 дней), повторное использование.
 - [x] [P0] Верификация резервных копий: проверка целостности структуры и base64‑обложек перед импортом.

## Безопасность и права
- [x] [P0] Доступ к ФС только в `main`: все операции файлов — через IPC; в рендерере без Node.
- [ ] [P2] Верификация импортов: проверка расширений/размеров, защита от zip‑slip при распаковке.

## Сборка и обновления
- [ ] [P1] Пакетирование: `electron-builder`/`electron-forge` для dmg/exe/AppImage; автообновления (при возможности) и подпись.
- [ ] [P1] Модульная структура: разделить `src/main/*` (ipc, storage, covers, importers) и `src/renderer/*` (views, state, components).

## Как реализовать ключевые блоки
- [x] [P0] SQLite (main): `src/main/db.js` — инициализация, миграции, CRUD; IPC: `books:list|create|update|delete`.
- [x] [P1] Импорт ISBN: агрегатор `src/main/providers/isbn.js` (ISBNdb → Open Library), кеш `isbn_cache`, IPC `meta:byIsbn`, кнопка «Обновить» (ignore cache).
- [ ] [P1] Импорт CSV: `src/main/importers/csv.js` — парсер, маппинг колонок, dry‑run + отчёт.
- [x] [P0] Поиск (renderer): `src/renderer/search.js` — Fuse.js, фильтры в памяти; для больших коллекций — IPC‑фильтры по SQLite.
- [ ] [P2] Вложения: копирование в `userData/library/files`, относительные пути; генерация миниатюр при импорте.
- [x] [P1] AI‑обогащение ISBN:
  - main: `src/main/ai/isbn_enrich.js` (OpenAI client, промпт, вызов модели, кэш `ai_isbn_cache`, лимит конкуренции/рейтов), IPC `ai:isbn:enrich`.
  - renderer: `src/renderer/enrich.js` + вкладка UI (загрузка CSV, маппинг колонок: title/authors/year/publisher, предпросмотр, очередь, управление).
  - формат ответа: строгое JSON `{ isbn13: string|null, confidence: 0..1, rationale?: string }`.
  - пост‑верификация: по найденному ISBN вызывать ISBNdb/OL, показывать title/author/year для сравнения.
  - экспорт: сохранить обновлённый CSV с колонкой `isbn` и полями верификации.
  - доп.: режим без заголовков CSV, очистка кэша, игнор кэша, панель отладки (prompt/raw), переключатель вида в шапке.

## Предложенный порядок работ
1) Перевести хранилище на SQLite с таблицами и индексами.
2) Добавить быстрый поиск, фильтры и сохранённые коллекции.
3) Импорт по ISBN с автозаполнением.
4) Поддержка вложений eBook/PDF и генерация обложек.
5) Дедупликация и мастер объединения записей.
